#!/bin/zsh

# Login to lxplus
# ===============
#
# Login to CERN's lxplus server. You can login to either the first available
# node or to a specific node (which is useful if you have a screen session
# running on that node, as screen sessions cannot be accessed from other nodes).
#
# Usage
# -----
#
# $ lxplus [--help] <node>

# Number of given arguments
argc=$#

# Get username from scripts repository
USER="$( cd "$( dirname "${(%):-%N}" )" && cat $(pwd)/.username )"

USAGE="usage: lxplus [--help] <node>"

# Print help message
if [[ $1 == "--help" ]] && ((argc == 1)); then
    echo $USAGE
    exit 0
fi

# Print help message
if [[ $1 == "--help" ]] && ((argc > 1)); then
    echo "lxplus: unrecognized option '${@:2}'"
    echo $USAGE
    exit 1
fi


# Check if Kerberos ticket exists
echo "Checking Kerberos tickets..."
eval klist
k_code=$?  # Return code; 0 if all good, 1 if no ticket

if (($k_code == 1)); then
    echo "Enter Kerberos credentials:"
    eval init-krb
fi


# No node given; let lxplus decide
if (($argc == 0)); then
	echo
    echo ">>> ssh ${USER}@lxplus.cern.ch"
    ssh ${USER}@lxplus.cern.ch
fi

# Login to the specific node
if (($argc == 1)); then
    node=$1
    echo
    echo ">>> ssh ${USER}@lxplus${node}.cern.ch"
    ssh ${USER}@lxplus${node}.cern.ch
fi
